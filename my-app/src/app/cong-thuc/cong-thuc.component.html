<!-- Thông báo -->
<div
  *ngIf="notification.show"
  class="notification"
  [ngClass]="{
    'notification-success': notification.type === 'success',
    'notification-error': notification.type === 'error'
  }"
>
  <div class="notification-content">
    <div *ngIf="notification.type === 'success'" class="notification-icon">
      <img src="../../assets/check.svg" alt="Success" />
    </div>
    <div *ngIf="notification.type === 'error'" class="notification-icon">
      <img src="../../assets/error.svg" alt="Error" />
    </div>
    <span>{{ notification.message }}</span>
  </div>
</div>

<div class="maincontainer container-fluid">
  <!-- Thêm link Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <a class="banner" routerLink="/san-pham">
    <img src="../../assets/trang-chu/banner3.jpg" alt="" />
  </a>
  <div class="products-container">
    <div class="filter-bar">
      <div class="filter-button-container">
        <button
          *ngFor="let region of regions"
          [class.button-cam]="selectedRegion === region"
          [class.button-trang]="selectedRegion !== region"
          (click)="onRegionChange(region)"
        >
          {{ region }}
        </button>
      </div>
      <div class="search-container">
        <div class="filter-dropdown-container">
          <button class="button-trang" (click)="toggleFilterDropdown($event)">
            <img src="../../assets/cong-thuc/filter.svg" alt="Bộ lọc" />
            Bộ lọc
          </button>
          <div
            class="filter-dropdown"
            *ngIf="showFilterDropdown"
            (click)="$event.stopPropagation()"
          >
            <div class="filter-section">
              <h4>Nguyên liệu</h4>
              <div class="ingredients-search">
                <input
                  type="text"
                  placeholder="Tìm nguyên liệu..."
                  #ingredientSearch
                  (input)="searchIngredients($event)"
                />
              </div>
              <div class="ingredients-list">
                <div
                  *ngFor="let ingredient of filteredIngredientsList"
                  class="filter-option"
                  [class.selected]="selectedIngredients.includes(ingredient)"
                  (click)="toggleIngredient(ingredient)"
                >
                  <span class="option-name">{{ ingredient }}</span>
                  <span
                    class="checkmark"
                    *ngIf="selectedIngredients.includes(ingredient)"
                    >✓</span
                  >
                </div>
                <div
                  *ngIf="filteredIngredientsList.length === 0"
                  class="no-ingredients"
                >
                  Không tìm thấy nguyên liệu nào
                </div>
              </div>
            </div>

            <div class="filter-actions">
              <button
                class="button-trang"
                (click)="clearFilters(); $event.stopPropagation()"
              >
                Xóa bộ lọc
              </button>
              <button class="button-cam" (click)="toggleFilterDropdown($event)">
                Áp dụng
              </button>
            </div>
            <!-- Thêm thông báo số lượng công thức đã lọc -->
            <div class="filter-summary" *ngIf="selectedIngredients.length > 0">
              <div class="filter-badge">
                Đã tìm thấy: {{ filteredRecipes.length }} công thức chứa TẤT CẢ
                nguyên liệu đã chọn
              </div>
              <div class="selected-ingredients">
                <span
                  *ngFor="let ing of selectedIngredients"
                  class="ingredient-tag"
                >
                  {{ ing }}
                  <span
                    class="remove-tag"
                    (click)="toggleIngredient(ing); $event.stopPropagation()"
                    >×</span
                  >
                </span>
              </div>
            </div>
          </div>
        </div>

        <div class="sort-dropdown">
          <button class="sort-button">
            Sắp xếp theo: {{ getSelectedSortLabel() }}
          </button>
          <div class="sort-options">
            <div
              *ngFor="let option of sortOptions"
              class="sort-option"
              (click)="selectSort(option.value)"
              [class.active]="selectedSort === option.value"
            >
              {{ option.label }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="loading-error" *ngIf="isLoading || errorMessage">
      <div class="loading" *ngIf="isLoading">Đang tải công thức...</div>
      <div class="error" *ngIf="errorMessage">{{ errorMessage }}</div>
    </div>

    <!-- Hiển thị các nguyên liệu đã lọc -->
    <div class="active-filters" *ngIf="selectedIngredients.length > 0">
      <div class="filters-title">
        Đang hiển thị công thức chứa TẤT CẢ nguyên liệu:
      </div>
      <div class="filters-tags">
        <span *ngFor="let ing of selectedIngredients" class="filter-tag">
          {{ ing }}
          <span class="remove-filter" (click)="toggleIngredient(ing)">×</span>
        </span>
        <button class="clear-filters" (click)="clearFilters()">
          Xóa bộ lọc
        </button>
      </div>
    </div>

    <!-- Main content -->
    <div class="products-grid">
      <div class="product-card" *ngFor="let recipe of paginatedRecipes">
        <!-- Nút lưu công thức - thay đổi thiết kế -->
        <div
          class="save-button"
          (click)="toggleSaveRecipe($event, recipe)"
          [class.active]="isRecipeSaved(recipe._id)"
        >
          <i
            class="fa-heart"
            [ngClass]="isRecipeSaved(recipe._id) ? 'fas' : 'far'"
          ></i>
        </div>

        <a [routerLink]="['/cong-thuc', recipe._id]">
          <img
            [src]="recipe.recipeImage"
            [alt]="recipe.recipeName"
            class="product-image"
            onerror="this.onerror=null; this.src='../../assets/san-pham/no-image.png'"
          />
          <div class="product-content">
            <h5 class="product-title">{{ recipe.recipeName }}</h5>
            <div class="product-info">
              <div class="info-item">
                <img src="../../assets/san-pham/khauphan.svg" alt="category" />
                <span>4 Người</span>
              </div>
              <div class="info-item">
                <img src="../../assets/san-pham/dokho.svg" alt="difficulty" />
                <span>{{ recipe.difficulty }}</span>
              </div>
              <div class="info-item">
                <img
                  src="../../assets/san-pham/ph-cooking-pot.svg"
                  alt="time"
                />
                <span>{{ recipe.time }}</span>
              </div>
            </div>
            <div class="product-actions">
              <button class="button-camnhat">XEM CHI TIẾT</button>
            </div>
          </div>
        </a>
      </div>
    </div>

    <div
      class="no-results"
      *ngIf="!isLoading && !errorMessage && filteredRecipes.length === 0"
    >
      <p *ngIf="selectedIngredients.length > 0">
        Không tìm thấy công thức nào chứa TẤT CẢ nguyên liệu:
        <span
          class="highlight-ingredient"
          *ngFor="let ing of selectedIngredients; let last = last"
        >
          {{ ing }}{{ !last ? ", " : "" }}
        </span>
      </p>
      <p *ngIf="selectedIngredients.length === 0">
        Không tìm thấy công thức nào phù hợp.
      </p>
      <button
        class="button-cam"
        *ngIf="selectedIngredients.length > 0"
        (click)="clearFilters()"
      >
        Xóa bộ lọc
      </button>
    </div>

    <div class="pagination" *ngIf="filteredRecipes.length > itemsPerPage">
      <button
        class="page-number"
        (click)="previousPage()"
        [disabled]="currentPage === 1"
      >
        ←
      </button>
      <button
        class="page-number"
        *ngFor="let page of displayedPages"
        [class.active]="currentPage === page"
        (click)="goToPage(page)"
      >
        {{ page }}
      </button>
      <button
        class="page-number"
        (click)="nextPage()"
        [disabled]="currentPage === totalPages"
      >
        →
      </button>
    </div>
  </div>
</div>
